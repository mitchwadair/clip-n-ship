/**
 * @license
 * Copyright (c) 2021 Mitchell Adair
 *
 * This software is released under the MIT License.
 * https://opensource.org/licenses/MIT
 */
class ClipConverter{constructor(e){if(!e)throw new Error("Must include video data when instantiating a ClipConverter");this._layers=[],this._canvas=this._createCanvas(),this._video=this._createVideo(e),this._playInterval}_createCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","clipnship-canvas"),e.setAttribute("width","1080"),e.setAttribute("height","1920"),e}_createVideo(e){const t=document.createElement("video");return t.setAttribute("hidden",""),t.setAttribute("src",e),t.onplay=()=>{clearInterval(this._playInterval),this._playInterval=setInterval(()=>this._drawLayers(),1e3/60)},t.onpause=()=>clearInterval(this._playInterval),t.onended=()=>clearInterval(this._playInterval),t.onloadedmetadata=()=>t.currentTime=0,t.onseeked=()=>window.requestAnimationFrame(()=>this._drawLayers()),t}_calculateRenderValues(e,t=1){var r=e.videoWidth,e=e.videoHeight;return{offsetX:(e-r*t)/2,offsetY:(r-e*t)/2,width:r*t,height:e*t}}_drawLayers(){const t=this._canvas.getContext("2d");for(let e=0;e<this._layers.length;e++){var r=this._layers[e],{offsetX:a,offsetY:i,width:s,height:n}=this._calculateRenderValues(r.source,r.scale);t.filter=r.filter,t.drawImage(r.source,a,i,s,n)}}getPreview(e="500px"){return this._canvas.style="width: "+e,this._canvas}addLayer(e,t,r="none"){if(this.getLayer(e))throw new Error(`Layer with name "${e}" already exists`);return this._layers.push({name:e,scale:t,filter:r,source:this._video}),this._drawLayers(),this._layers}getLayer(t){return this._layers.find(e=>e.name===t)}removeLayer(t){return this._layers=this._layers.filter(e=>e.name!==t),this._drawLayers(),this._layers}getLayers(){return this._layers}updateLayerScale(e,t){const r=this.getLayer(e);if(!r)throw new Error(`Layer with name "${e}" not found`);return r.scale=t,this._drawLayers(),this._layers}updateLayerFilter(e,t){const r=this.getLayer(e);if(!r)throw new Error(`Layer with name "${e}" not found`);return r.filter=t,this._drawLayers(),this._layers}previewPlay(){this._video.play()}previewPause(){this._video.pause()}previewReset(){this.previewPause(),this._video.currentTime=0}render(e,t,r=()=>{}){const a=this._canvas.captureStream(e),i=this._video.captureStream(e);e=new MediaStream([...a.getVideoTracks(),...i.getAudioTracks()]);const s=new MediaRecorder(e,{mimeType:"video/webm;codecs=vp9"});let n=[];s.ondataavailable=e=>{n.push(e.data),r(this._video.currentTime/this._video.duration)},s.onstop=()=>{this._video.volume=1,t(new Blob(n,{type:"video/webm;codecs=vp9"}))},this.previewReset(),this._video.volume=.001,s.start(500),this._video.play(),this._video.onended=()=>{clearInterval(this._playInterval),s.stop()}}}window.ClipConverter=ClipConverter;