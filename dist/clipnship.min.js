/**
 * @license
 * Copyright (c) 2021-2022 Mitchell Adair
 *
 * This software is released under the MIT License.
 * https://opensource.org/licenses/MIT
 */
class ClipConverter{constructor(e,t=1080,r=1920){if(!e)throw new Error("Must include video data when instantiating a ClipConverter");this._layers=[],this._dimensions={width:t,height:r},this._canvas=this._createCanvas(),this._video=this._createVideo(e),this._playInterval}_createCanvas(){var{width:e,height:t}=this._dimensions;const r=document.createElement("canvas");return r.setAttribute("id","clipnship-canvas"),r.setAttribute("width",e),r.setAttribute("height",t),r}_createVideo(e){const t=document.createElement("video");return t.setAttribute("hidden",""),t.setAttribute("src",e),t.onplay=()=>{clearInterval(this._playInterval),this._playInterval=setInterval(()=>this._drawLayers(),1e3/60)},t.onpause=()=>clearInterval(this._playInterval),t.onended=()=>clearInterval(this._playInterval),t.onloadedmetadata=()=>t.currentTime=0,t.onseeked=()=>window.requestAnimationFrame(()=>this._drawLayers()),t}_calculateRenderValues(e=1){var{width:t,height:r}=this._dimensions;let a,i,s,n;return i=n=r<t?(a=s=t,r):(a=s=r,t),{offsetX:(t-s*e)/2,offsetY:(r-n*e)/2,width:a*e,height:i*e}}_drawLayers(){const t=this._canvas.getContext("2d");for(let e=0;e<this._layers.length;e++){var{source:r,scale:a,filter:i}=this._layers[e],{offsetX:s,offsetY:n,width:h,height:a}=this._calculateRenderValues(a);t.filter=i,t.drawImage(r,s,n,h,a)}}getPreview(e="500px"){return this._canvas.style="width: "+e,this._canvas}addLayer(e,t,r="none"){if(this.getLayer(e))throw new Error(`Layer with name "${e}" already exists`);return this._layers.push({name:e,scale:t,filter:r,source:this._video}),this._drawLayers(),this._layers}getLayer(t){return this._layers.find(e=>e.name===t)}removeLayer(t){return this._layers=this._layers.filter(e=>e.name!==t),this._drawLayers(),this._layers}getLayers(){return this._layers}updateLayerScale(e,t){const r=this.getLayer(e);if(!r)throw new Error(`Layer with name "${e}" not found`);return r.scale=t,this._drawLayers(),this._layers}updateLayerFilter(e,t){const r=this.getLayer(e);if(!r)throw new Error(`Layer with name "${e}" not found`);return r.filter=t,this._drawLayers(),this._layers}previewPlay(){this._video.play()}previewPause(){this._video.pause()}previewReset(){this.previewPause(),this._video.currentTime=0}render(e,t,r=()=>{}){const a=this._canvas.captureStream(e),i=this._video.captureStream(e);e=new MediaStream([...a.getVideoTracks(),...i.getAudioTracks()]);const s=new MediaRecorder(e,{mimeType:"video/webm;codecs=vp9"});let n=[];s.ondataavailable=e=>{n.push(e.data),r(this._video.currentTime/this._video.duration)},s.onstop=()=>{this._video.volume=1,t(new Blob(n,{type:"video/webm;codecs=vp9"}))},this.previewReset(),this._video.volume=.001,s.start(500),this._video.play(),this._video.onended=()=>{clearInterval(this._playInterval),s.stop()}}}window.ClipConverter=ClipConverter;